<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Bucket Budget App</title>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a6fd6;
            --secondary: #764ba2;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #2d3748;
            --text-light: #718096;
            --danger: #fc8181;
            --radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: 40px;
        }

        /* Compact Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 20px 20px 50px;
            color: white;
            text-align: center;
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .header h1 { 
            font-weight: 800; 
            font-size: 1.8rem;
            letter-spacing: -0.5px; 
            margin-bottom: 5px; 
        }

        /* User Selector */
        .user-section {
            max-width: 600px;
            margin: 15px auto 0;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .user-select {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            min-width: 150px;
        }

        .user-select option {
            background: var(--primary);
            color: white;
        }

        .btn-user {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .btn-user:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Add User Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: var(--text-main);
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-actions .btn-primary {
            background: var(--primary);
            color: white;
        }

        .modal-actions .btn-cancel {
            background: #e2e8f0;
            color: var(--text-main);
        }

        /* Sync Controls */
        .sync-wrapper {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .sync-pill {
            background: rgba(0, 0, 0, 0.15);
            padding: 8px 12px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.9);
        }

        .sync-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .sync-btn:hover { background: rgba(255,255,255,0.3); }

        /* Compact Income Bar (Floating) */
        .income-bar-container {
            max-width: 600px;
            margin: -35px auto 20px;
            padding: 0 15px;
            position: relative;
            z-index: 20;
        }

        .income-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.5);
        }

        .income-label {
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 600;
        }

        .income-input-compact {
            border: none;
            background: transparent;
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--primary);
            text-align: right;
            width: 120px;
            outline: none;
            border-bottom: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .income-input-compact:focus {
            border-bottom-color: var(--primary);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .card.expense-section {
            background-color: #eff6ff;
            border: 1px solid #dbeafe;
        }

        .card h2 {
            font-size: 1.3rem;
            color: var(--text-main);
            margin-bottom: 15px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Setup Panel */
        .setup-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
        }

        .setup-panel h3 {
            color: var(--text-main);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .setup-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: center;
        }

        .setup-label {
            min-width: 100px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .setup-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: 'Courier New', monospace;
        }

        .setup-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .setup-help {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 5px;
            font-style: italic;
        }

        .setup-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-save {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-save:hover {
            background: var(--primary-dark);
        }

        .btn-cancel {
            background: #e2e8f0;
            color: var(--text-main);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Presets Grid - Compact */
        .presets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 25px;
        }

        .preset-btn {
            background: white;
            border: 1px solid #e2e8f0;
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .preset-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        .preset-btn strong { display: block; color: var(--text-main); font-size: 0.85rem; margin-bottom: 2px; }
        .preset-btn small { color: var(--text-light); font-size: 0.75rem; display: block; }

        /* Buckets */
        .buckets-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Daily Expenses Group - Special treatment */
        .daily-group {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 25px;
            color: white;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .daily-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .daily-title {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .daily-total {
            text-align: right;
        }

        .daily-total-amount {
            font-size: 2.2rem;
            font-weight: 800;
        }

        .daily-total-percent {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .daily-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .daily-sub-bucket {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .daily-sub-title {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .daily-sub-amount {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .daily-sub-desc {
            font-size: 0.75rem;
            opacity: 0.8;
            line-height: 1.3;
        }

        /* Other Savers Grid */
        .savers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .saver-bucket {
            border-radius: 16px;
            padding: 20px;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .saver-bucket.splurge { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .saver-bucket.smile { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .saver-bucket.fire { background: linear-gradient(135deg, #ff9a56 0%, #ff6a00 100%); }

        .saver-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .saver-title {
            font-size: 1.05rem;
            font-weight: 600;
            opacity: 0.95;
        }

        .saver-amount {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .saver-percent {
            font-size: 0.9rem;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-edit-percent {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-edit-percent:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Slider Panel (hidden by default) */
        .slider-panel {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .slider-panel.active {
            display: block;
        }

        .slider-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        input[type=range] {
            flex: 1;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        /* Expenses Section */
        .expense-form {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            background: #f8fafc;
        }
        
        .form-input:focus { border-color: var(--primary); outline: none; background: white; }

        .btn-add {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 20px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-add:hover { background: var(--primary-dark); }

        .expense-list { display: flex; flex-direction: column; gap: 10px; }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            border: 1px solid rgba(255,255,255,0.5);
            transition: transform 0.2s;
        }

        .expense-item:hover { transform: translateX(3px); }

        .expense-details h4 { font-size: 0.95rem; color: var(--text-main); margin-bottom: 3px; }
        
        .expense-meta { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: var(--text-light); }
        
        .badge {
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-fortnightly { background: #dbeafe; color: #1e40af; } /* Blue */
        .badge-weekly { background: #d1fae5; color: #065f46; } /* Green */
        .badge-monthly { background: #fed7aa; color: #9a3412; } /* Orange */
        .badge-oneoff { background: #fef3c7; color: #92400e; } /* Yellow */

        .converted-cost { font-style: italic; opacity: 0.8; font-size: 0.75rem; }

        .expense-actions { display: flex; align-items: center; gap: 12px; }
        .expense-cost { font-weight: 700; color: var(--text-main); font-size: 1rem; }
        
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            color: #a0aec0;
            font-size: 0.9rem;
            padding: 5px;
            transition: color 0.2s;
        }
        .btn-icon:hover { color: var(--primary); }
        .btn-icon.delete:hover { color: var(--danger); }

        .footer-actions {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(0,0,0,0.05);
            display: flex;
            gap: 15px;
        }

        .btn-secondary {
            background: white;
            border: 1px solid #cbd5e0;
            padding: 8px 16px;
            border-radius: 8px;
            color: var(--text-light);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .expense-form { grid-template-columns: 1fr; }
            .btn-add { padding: 12px; }
            .expense-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .expense-actions { width: 100%; justify-content: space-between; }
            .setup-row { flex-direction: column; align-items: stretch; }
            .setup-label { min-width: auto; }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>The Bucket Budget App</h1>
        
        <!-- User Selector -->
        <div class="user-section">
            <select class="user-select" id="user-select" onchange="switchUser()">
                <option value="">Select User...</option>
            </select>
            <button class="btn-user" onclick="addNewUser()">‚ûï Add User</button>
            <button class="btn-user" onclick="deleteCurrentUser()">üóëÔ∏è Delete</button>
        </div>

        <!-- Sync Controls -->
        <div class="sync-wrapper">
            <div class="sync-pill">
                <span id="sync-text">GitHub Gist</span>
                <button class="sync-btn" onclick="syncToGitHub()">Push</button>
                <button class="sync-btn" onclick="loadFromGitHub()">Pull</button>
                <button class="sync-btn" onclick="toggleSetup()">‚öôÔ∏è</button>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal" id="add-user-modal">
        <div class="modal-content">
            <h3>‚ûï Add New User</h3>
            <input type="text" class="modal-input" id="new-username" placeholder="Enter name (e.g. Mom, Dad, Sarah)">
            <div class="modal-actions">
                <button class="btn-primary" onclick="confirmAddUser()">Create</button>
                <button class="btn-cancel" onclick="closeAddUserModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="income-bar-container">
        <div class="income-bar">
            <span class="income-label">My Fortnightly Pay</span>
            <div style="display:flex; align-items:center; gap:5px;">
                <span style="color:var(--text-light); font-weight:600;">$</span>
                <input type="number" id="income" class="income-input-compact" placeholder="0.00" step="0.01">
            </div>
        </div>
    </div>

    <div class="container">
        
        <!-- Setup Panel (Hidden by default) -->
        <div class="setup-panel" id="setup-panel" style="display: none;">
            <h3>‚öôÔ∏è GitHub Sync Settings</h3>
            
            <div class="setup-row">
                <span class="setup-label">GitHub Token:</span>
                <input type="password" class="setup-input" id="setup-token" placeholder="ghp_xxxxxxxxxxxx">
            </div>
            <div class="setup-help">Create at: github.com/settings/tokens (need 'gist' scope)</div>
            
            <div class="setup-row">
                <span class="setup-label">Gist ID:</span>
                <input type="text" class="setup-input" id="setup-gist" placeholder="Leave blank to create new, or paste existing">
            </div>
            <div class="setup-help">After first Push, your Gist ID will appear here. Copy it to use on other devices.</div>
            
            <div class="setup-actions">
                <button class="btn-save" onclick="saveSetup()">Save Settings</button>
                <button class="btn-cancel" onclick="toggleSetup()">Close</button>
            </div>
        </div>

        <div class="card">
            <h2>ü™£ The Buckets</h2>
            
            <div class="presets-grid">
                <button class="preset-btn" onclick="applyPreset('standard')">
                    <strong>üìò Standard Barefoot</strong>
                    <small>60 / 10 / 10 / 20</small>
                </button>
                <button class="preset-btn" onclick="applyPreset('aggressive')">
                    <strong>üí™ Aggressive Saving</strong>
                    <small>50 / 5 / 10 / 35</small>
                </button>
                <button class="preset-btn" onclick="applyPreset('balanced')">
                    <strong>‚öñÔ∏è Balanced Life</strong>
                    <small>55 / 15 / 10 / 20</small>
                </button>
                <button class="preset-btn" onclick="applyPreset('recovery')">
                    <strong>üö® Recovery Mode</strong>
                    <small>55 / 5 / 20 / 20</small>
                </button>
                <button class="preset-btn" onclick="applyPreset('custom')" style="border-style: dashed;">
                    <strong>üéØ Save Custom</strong>
                    <small>Current Settings</small>
                </button>
            </div>

            <div class="buckets-container">
                <!-- Daily Expenses Group -->
                <div class="daily-group">
                    <div class="daily-header">
                        <div>
                            <div class="daily-title">üìä Daily Expenses</div>
                            <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 5px;">Split into Bills + Essentials</div>
                        </div>
                        <div class="daily-total">
                            <div class="daily-total-amount">$<span id="daily-total-amount">0.00</span></div>
                            <div class="daily-total-percent">
                                <span id="daily-percent">60</span>% 
                                <button class="btn-edit-percent" onclick="toggleSlider('daily')">Edit %</button>
                            </div>
                        </div>
                    </div>

                    <div class="daily-breakdown">
                        <div class="daily-sub-bucket">
                            <div class="daily-sub-title">üè¶ Bills Account</div>
                            <div class="daily-sub-amount">$<span id="bills-amount">0.00</span></div>
                            <div class="daily-sub-desc">Fixed bills & direct debits</div>
                        </div>
                        <div class="daily-sub-bucket">
                            <div class="daily-sub-title">üõí Essentials Account</div>
                            <div class="daily-sub-amount">$<span id="spending-amount">0.00</span></div>
                            <div class="daily-sub-desc">Groceries, fuel, medication</div>
                        </div>
                    </div>

                    <div class="slider-panel" id="daily-slider-panel">
                        <div class="slider-wrapper">
                            <span class="slider-value"><span id="daily-slider-value">60</span>%</span>
                            <input type="range" min="0" max="100" value="60" id="daily-slider">
                        </div>
                    </div>
                </div>

                <!-- Other Savers -->
                <div class="savers-grid">
                    <div class="saver-bucket splurge">
                        <div class="saver-header">
                            <div class="saver-title">üí∏ Splurge</div>
                        </div>
                        <div class="saver-amount">$<span id="splurge-amount">0.00</span></div>
                        <div class="saver-percent">
                            <span id="splurge-percent">10</span>%
                            <button class="btn-edit-percent" onclick="toggleSlider('splurge')">Edit</button>
                        </div>
                        <div class="slider-panel" id="splurge-slider-panel">
                            <div class="slider-wrapper">
                                <span class="slider-value"><span id="splurge-slider-value">10</span>%</span>
                                <input type="range" min="0" max="50" value="10" id="splurge-slider">
                            </div>
                        </div>
                    </div>

                    <div class="saver-bucket smile">
                        <div class="saver-header">
                            <div class="saver-title">üèñÔ∏è Smile</div>
                        </div>
                        <div class="saver-amount">$<span id="smile-amount">0.00</span></div>
                        <div class="saver-percent">
                            <span id="smile-percent">10</span>%
                            <button class="btn-edit-percent" onclick="toggleSlider('smile')">Edit</button>
                        </div>
                        <div class="slider-panel" id="smile-slider-panel">
                            <div class="slider-wrapper">
                                <span class="slider-value"><span id="smile-slider-value">10</span>%</span>
                                <input type="range" min="0" max="50" value="10" id="smile-slider">
                            </div>
                        </div>
                    </div>

                    <div class="saver-bucket fire">
                        <div class="saver-header">
                            <div class="saver-title">üöí Fire Extinguisher</div>
                        </div>
                        <div class="saver-amount">$<span id="fire-amount">0.00</span></div>
                        <div class="saver-percent">
                            <span id="fire-percent">20</span>%
                            <button class="btn-edit-percent" onclick="toggleSlider('fire')">Edit</button>
                        </div>
                        <div class="slider-panel" id="fire-slider-panel">
                            <div class="slider-wrapper">
                                <span class="slider-value"><span id="fire-slider-value">20</span>%</span>
                                <input type="range" min="0" max="50" value="20" id="fire-slider">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="percentage-warning" style="display: none; background: #fff5f5; color: #c53030; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #fed7d7;"></div>
        </div>

        <div class="card expense-section">
            <h2>üí≥ Bills & Expenses</h2>
            
            <div class="expense-form">
                <input type="text" class="form-input" id="expense-name" placeholder="Description (e.g. Rent)">
                <input type="number" class="form-input" id="expense-amount" placeholder="Amount" step="0.01">
                <select class="form-input" id="expense-frequency">
                    <option value="fortnightly">Fortnightly</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="oneoff">One-off</option>
                </select>
                <button class="btn-add" id="add-update-btn" onclick="addOrUpdateExpense()">Add</button>
            </div>

            <div class="expense-list" id="expenses-list"></div>

            <div class="footer-actions">
                <button class="btn-secondary" onclick="exportData()">üì• Export JSON</button>
                <button class="btn-secondary" style="color: var(--danger); border-color: #fed7d7;" onclick="resetExpenses()">Reset All</button>
            </div>
        </div>

    </div>

    <script>
        // --- USER & GITHUB CONFIG ---
        let users = JSON.parse(localStorage.getItem('users')) || {};
        let currentUser = localStorage.getItem('currentUser') || '';

        const initialExpenses = [
            { name: 'Example: Rent', amount: 400, frequency: 'weekly' },
        ];

        let expenses = [];
        let netIncome = 0;
        let percentages = { daily: 60, splurge: 10, smile: 10, fire: 20 };
        let editingIndex = -1;
        let customPreset = null;

        const presets = {
            standard: { daily: 60, splurge: 10, smile: 10, fire: 20 },
            aggressive: { daily: 50, splurge: 5, smile: 10, fire: 35 },
            balanced: { daily: 55, splurge: 15, smile: 10, fire: 20 },
            recovery: { daily: 55, splurge: 5, smile: 20, fire: 20 }
        };

        // --- USER MANAGEMENT ---
        function loadUserList() {
            const select = document.getElementById('user-select');
            select.innerHTML = '<option value="">Select User...</option>';
            Object.keys(users).forEach(username => {
                const opt = document.createElement('option');
                opt.value = username;
                opt.textContent = username;
                if (username === currentUser) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function addNewUser() {
            const modal = document.getElementById('add-user-modal');
            modal.style.display = 'flex';
            document.getElementById('new-username').value = '';
            document.getElementById('new-username').focus();
        }

        function closeAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            modal.style.display = 'none';
        }

        function confirmAddUser() {
            const username = document.getElementById('new-username').value.trim();
            if (!username) {
                alert("Please enter a name");
                return;
            }
            if (users[username]) {
                alert("User already exists!");
                return;
            }
            
            users[username] = {
                ghToken: '',
                gistId: '',
                data: {
                    expenses: [...initialExpenses],
                    netIncome: 0,
                    percentages: { daily: 60, splurge: 10, smile: 10, fire: 20 },
                    customPreset: null
                }
            };
            
            localStorage.setItem('users', JSON.stringify(users));
            currentUser = username;
            localStorage.setItem('currentUser', currentUser);
            loadUserList();
            loadUserData();
            closeAddUserModal();
        }

        function switchUser() {
            const select = document.getElementById('user-select');
            currentUser = select.value;
            if (!currentUser) return;
            localStorage.setItem('currentUser', currentUser);
            loadUserData();
            
            // Auto-pull on switch if configured
            const user = users[currentUser];
            if (user && user.ghToken && user.gistId) {
                loadFromGitHub();
            }
        }

        function deleteCurrentUser() {
            if (!currentUser) return alert("No user selected");
            if (!confirm(`Delete user "${currentUser}"? This cannot be undone.`)) return;
            
            delete users[currentUser];
            localStorage.setItem('users', JSON.stringify(users));
            currentUser = '';
            localStorage.setItem('currentUser', '');
            loadUserList();
            
            // Reset UI
            expenses = [...initialExpenses];
            netIncome = 0;
            percentages = { daily: 60, splurge: 10, smile: 10, fire: 20 };
            refreshUI();
        }

        function loadUserData() {
            if (!currentUser || !users[currentUser]) {
                expenses = [...initialExpenses];
                netIncome = 0;
                percentages = { daily: 60, splurge: 10, smile: 10, fire: 20 };
                customPreset = null;
                refreshUI();
                return;
            }
            
            const userData = users[currentUser].data;
            expenses = userData.expenses || [...initialExpenses];
            netIncome = userData.netIncome || 0;
            percentages = userData.percentages || { daily: 60, splurge: 10, smile: 10, fire: 20 };
            customPreset = userData.customPreset || null;
            
            refreshUI();
        }

        function saveUserData() {
            if (!currentUser) return;
            
            users[currentUser].data = {
                expenses,
                netIncome,
                percentages,
                customPreset
            };
            
            localStorage.setItem('users', JSON.stringify(users));
        }

        // --- SETUP PANEL ---
        function toggleSetup() {
            const panel = document.getElementById('setup-panel');
            const isVisible = panel.style.display !== 'none';
            
            if (isVisible) {
                panel.style.display = 'none';
            } else {
                // Load current user's settings
                if (currentUser && users[currentUser]) {
                    document.getElementById('setup-token').value = users[currentUser].ghToken || '';
                    document.getElementById('setup-gist').value = users[currentUser].gistId || '';
                }
                panel.style.display = 'block';
            }
        }

        function saveSetup() {
            if (!currentUser) return alert("Please select or create a user first");
            
            const token = document.getElementById('setup-token').value.trim();
            const gistId = document.getElementById('setup-gist').value.trim();
            
            users[currentUser].ghToken = token;
            users[currentUser].gistId = gistId;
            localStorage.setItem('users', JSON.stringify(users));
            
            alert("Settings saved!");
            toggleSetup();
        }

        // --- GITHUB SYNC FUNCTIONS ---
        async function syncToGitHub() {
            if (!currentUser) return alert("Please select a user first");
            const user = users[currentUser];
            if (!user.ghToken) return alert("Please set up GitHub Token first (‚öôÔ∏è)");
            
            updateSyncStatus('syncing');

            const payload = {
                description: `Budget data for ${currentUser}`,
                public: false,
                files: { 
                    [`budget-${currentUser}.json`]: { 
                        content: JSON.stringify({ expenses, netIncome, percentages, customPreset }, null, 2) 
                    } 
                }
            };

            try {
                const url = user.gistId 
                    ? `https://api.github.com/gists/${user.gistId}` 
                    : 'https://api.github.com/gists';
                const method = user.gistId ? 'PATCH' : 'POST';

                console.log('Pushing to GitHub...', { url, method, hasToken: !!user.ghToken });

                const response = await fetch(url, {
                    method,
                    headers: { 
                        'Authorization': `token ${user.ghToken}`, 
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(payload)
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('GitHub API Error:', errorText);
                    throw new Error(`GitHub API returned ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('Push successful:', data);

                if (data.id) {
                    user.gistId = data.id;
                    localStorage.setItem('users', JSON.stringify(users));
                    updateSyncStatus('connected');
                    
                    // Show the Gist ID in a copyable format
                    const message = `‚úÖ Data pushed successfully!\n\nYour Gist ID: ${data.id}\n\n(This has been saved automatically. You can also view it at:\n${data.html_url})`;
                    alert(message);
                    
                    // Update the settings panel if it's open
                    document.getElementById('setup-gist').value = data.id;
                } else {
                    throw new Error("No Gist ID in response");
                }
            } catch (error) {
                console.error("Push Error:", error);
                updateSyncStatus('error');
                
                let errorMessage = "Push failed. ";
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage += "\n\nPossible issues:\n" +
                                  "‚Ä¢ Check your internet connection\n" +
                                  "‚Ä¢ Your GitHub token may be invalid or expired\n" +
                                  "‚Ä¢ Token needs 'gist' scope permission\n\n" +
                                  "Create a new token at:\ngithub.com/settings/tokens/new\n" +
                                  "(Select 'gist' scope only)";
                } else if (error.message.includes('401')) {
                    errorMessage += "\n\nYour GitHub token is invalid or expired.\n" +
                                  "Create a new one at: github.com/settings/tokens";
                } else if (error.message.includes('404')) {
                    errorMessage += "\n\nGist not found. Try removing the Gist ID and pushing again to create a new one.";
                } else {
                    errorMessage += "\n\n" + error.message;
                }
                
                alert(errorMessage);
            }
        }

        async function loadFromGitHub() {
            if (!currentUser) return alert("Please select a user first");
            const user = users[currentUser];
            if (!user.ghToken || !user.gistId) return alert("Setup Token and Gist ID first (‚öôÔ∏è)");
            
            updateSyncStatus('syncing');
            try {
                console.log('Pulling from GitHub...', { gistId: user.gistId });
                
                const response = await fetch(`https://api.github.com/gists/${user.gistId}`, {
                    headers: { 
                        'Authorization': `token ${user.ghToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                console.log('Pull response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`GitHub API returned ${response.status}: ${errorText}`);
                }

                const gist = await response.json();
                const filename = Object.keys(gist.files)[0]; // Get first file
                const content = JSON.parse(gist.files[filename].content);
                
                console.log('Pull successful, loading data...');
                
                expenses = content.expenses || initialExpenses;
                netIncome = content.netIncome || 0;
                percentages = content.percentages || percentages;
                customPreset = content.customPreset || null;

                saveUserData();
                refreshUI();
                updateSyncStatus('connected');
                alert('‚úÖ Data pulled successfully!');
            } catch (e) {
                console.error('Pull error:', e);
                updateSyncStatus('error');
                
                let errorMessage = "Pull failed. ";
                
                if (e.message.includes('Failed to fetch')) {
                    errorMessage += "\n\nCheck your internet connection and GitHub token.";
                } else if (e.message.includes('401')) {
                    errorMessage += "\n\nYour GitHub token is invalid or expired.";
                } else if (e.message.includes('404')) {
                    errorMessage += "\n\nGist not found. Check your Gist ID.";
                } else {
                    errorMessage += "\n\n" + e.message;
                }
                
                alert(errorMessage);
            }
        }

        function updateSyncStatus(status) {
            const text = document.getElementById('sync-text');
            if (status === 'connected') text.textContent = '‚úì Synced';
            else if (status === 'syncing') text.textContent = '‚åõ Working...';
            else if (status === 'error') text.textContent = '‚ö†Ô∏è Error';
            else text.textContent = 'GitHub Gist';
        }

        // --- APP LOGIC ---
        
        function toggleSlider(bucket) {
            const panel = document.getElementById(`${bucket}-slider-panel`);
            const isActive = panel.classList.contains('active');
            
            // Close all slider panels first
            document.querySelectorAll('.slider-panel').forEach(p => p.classList.remove('active'));
            
            // Toggle current panel
            if (!isActive) {
                panel.classList.add('active');
            }
        }
        
        function calculateBuckets() {
            let totalBills = 0;
            
            expenses.forEach(exp => {
                let fortnightly = exp.amount;
                if (exp.frequency === 'weekly') fortnightly = exp.amount * 2;
                else if (exp.frequency === 'monthly') fortnightly = exp.amount / 2;
                else if (exp.frequency === 'oneoff') fortnightly = 0;
                totalBills += fortnightly;
            });

            const dailyTotal = netIncome * (percentages.daily / 100);
            const spending = Math.max(0, dailyTotal - totalBills);

            document.getElementById('bills-amount').textContent = totalBills.toFixed(2);
            document.getElementById('spending-amount').textContent = spending.toFixed(2);
            document.getElementById('daily-total-amount').textContent = dailyTotal.toFixed(2);
            document.getElementById('splurge-amount').textContent = (netIncome * percentages.splurge / 100).toFixed(2);
            document.getElementById('smile-amount').textContent = (netIncome * percentages.smile / 100).toFixed(2);
            document.getElementById('fire-amount').textContent = (netIncome * percentages.fire / 100).toFixed(2);
        }

        function renderExpenses() {
            const list = document.getElementById('expenses-list');
            list.innerHTML = expenses.map((exp, index) => {
                let fnCost = 0;
                let showConverted = false;
                if (exp.frequency === 'weekly') { fnCost = exp.amount * 2; showConverted = true; }
                else if (exp.frequency === 'monthly') { fnCost = exp.amount / 2; showConverted = true; }

                return `
                <div class="expense-item">
                    <div class="expense-details">
                        <h4>${exp.name}</h4>
                        <div class="expense-meta">
                            <span class="badge badge-${exp.frequency}">${exp.frequency}</span>
                            ${showConverted ? `<span class="converted-cost">‚âà $${fnCost.toFixed(2)} / fn</span>` : ''}
                        </div>
                    </div>
                    <div class="expense-actions">
                        <span class="expense-cost">$${exp.amount.toFixed(2)}</span>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-icon" onclick="editExpense(${index})">‚úé</button>
                            <button class="btn-icon delete" onclick="deleteExpense(${index})">‚úï</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            calculateBuckets();
        }

        function addOrUpdateExpense() {
            const name = document.getElementById('expense-name').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const frequency = document.getElementById('expense-frequency').value;
            if (!name || isNaN(amount)) return alert('Please check inputs');
            if (editingIndex >= 0) {
                expenses[editingIndex] = { name, amount, frequency };
                editingIndex = -1;
                document.getElementById('add-update-btn').textContent = 'Add';
            } else {
                expenses.push({ name, amount, frequency });
            }
            clearForm();
            saveUserData();
            renderExpenses();
        }

        function clearForm() {
            document.getElementById('expense-name').value = '';
            document.getElementById('expense-amount').value = '';
        }

        function editExpense(index) {
            const exp = expenses[index];
            document.getElementById('expense-name').value = exp.name;
            document.getElementById('expense-amount').value = exp.amount;
            document.getElementById('expense-frequency').value = exp.frequency;
            editingIndex = index;
            document.getElementById('add-update-btn').textContent = 'Update';
        }

        function deleteExpense(index) {
            if (confirm('Delete this expense?')) {
                expenses.splice(index, 1);
                saveUserData();
                renderExpenses();
            }
        }

        function applyPreset(name) {
            if (name === 'custom') {
                customPreset = { ...percentages };
                saveUserData();
                alert('Custom settings saved!');
                return;
            }
            const p = presets[name];
            if (p) {
                percentages = { ...p };
                updateAllSliders();
                saveUserData();
                calculateBuckets();
            }
        }

        function updateAllSliders() {
            ['daily', 'splurge', 'smile', 'fire'].forEach(key => {
                document.getElementById(`${key}-slider`).value = percentages[key];
                document.getElementById(`${key}-percent`).textContent = percentages[key];
                document.getElementById(`${key}-slider-value`).textContent = percentages[key];
            });
            checkPercentageTotal();
        }

        function checkPercentageTotal() {
            const total = Object.values(percentages).reduce((a, b) => a + b, 0);
            const warn = document.getElementById('percentage-warning');
            if (total !== 100) {
                warn.style.display = 'block';
                warn.innerHTML = `‚ö†Ô∏è <strong>Head's up:</strong> Percentages total <strong>${total}%</strong> (Aim for 100%)`;
            } else warn.style.display = 'none';
        }

        function refreshUI() {
            document.getElementById('income').value = netIncome;
            updateAllSliders();
            renderExpenses();
        }

        function resetExpenses() {
            if (confirm('Reset to default data?')) {
                expenses = [...initialExpenses];
                saveUserData();
                renderExpenses();
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify({expenses, netIncome, percentages, customPreset}, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; 
            a.download = `budget-${currentUser || 'export'}.json`; 
            a.click();
        }

        // LISTENERS
        document.getElementById('income').addEventListener('input', (e) => {
            netIncome = parseFloat(e.target.value) || 0;
            saveUserData();
            calculateBuckets();
        });

        ['daily', 'splurge', 'smile', 'fire'].forEach(key => {
            document.getElementById(`${key}-slider`).addEventListener('input', (e) => {
                percentages[key] = parseInt(e.target.value);
                document.getElementById(`${key}-percent`).textContent = percentages[key];
                document.getElementById(`${key}-slider-value`).textContent = percentages[key];
                checkPercentageTotal();
                saveUserData();
                calculateBuckets();
            });
        });

        // INIT
        window.onload = () => {
            loadUserList();
            if (currentUser) {
                loadUserData();
            }

            // Add Enter key support for modal
            document.getElementById('new-username').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    confirmAddUser();
                }
            });

            // Close modal when clicking outside
            document.getElementById('add-user-modal').addEventListener('click', (e) => {
                if (e.target.id === 'add-user-modal') {
                    closeAddUserModal();
                }
            });
        };
    </script>
</body>
</html>
