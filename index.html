<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barefoot Budget Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .sync-status {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 10px;
            margin-top: 15px;
            display: inline-block;
            backdrop-filter: blur(10px);
        }

        .sync-status.connected {
            background: rgba(76, 175, 80, 0.3);
        }

        .sync-status.syncing {
            background: rgba(255, 193, 7, 0.3);
        }

        .sync-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s;
        }

        .sync-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .income-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .income-input {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 15px;
        }

        .income-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            font-size: 1.2rem;
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .income-input input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .income-amount {
            font-size: 2rem;
            font-weight: bold;
            margin-top: 10px;
        }

        .buckets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .bucket {
            background: linear-gradient(135deg, var(--bucket-color-1) 0%, var(--bucket-color-2) 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .bucket-bills {
            --bucket-color-1: #f093fb;
            --bucket-color-2: #f5576c;
        }

        .bucket-spending {
            --bucket-color-1: #4facfe;
            --bucket-color-2: #00f2fe;
        }

        .bucket-splurge {
            --bucket-color-1: #43e97b;
            --bucket-color-2: #38f9d7;
        }

        .bucket-smile {
            --bucket-color-1: #fa709a;
            --bucket-color-2: #fee140;
        }

        .bucket-fire {
            --bucket-color-1: #ff9a56;
            --bucket-color-2: #ff6a00;
        }

        .bucket h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .bucket-amount {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .bucket-percentage {
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .slider-container {
            margin-top: 10px;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: rgba(255,255,255,0.3);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .expenses-section h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .expense-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 20px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #f5576c;
            color: white;
            padding: 5px 10px;
            font-size: 0.9rem;
        }

        .btn-danger:hover {
            background: #e74c60;
        }

        .expenses-list {
            margin-top: 20px;
        }

        .expense-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .expense-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .expense-info {
            flex: 1;
        }

        .expense-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .expense-meta {
            font-size: 0.9rem;
            color: #666;
        }

        .expense-amount {
            font-size: 1.3rem;
            font-weight: bold;
            color: #667eea;
            margin-right: 15px;
        }

        .frequency-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge-fortnightly {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-weekly {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-monthly {
            background: #e8f5e9;
            color: #388e3c;
        }

        .badge-oneoff {
            background: #fff3e0;
            color: #f57c00;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .summary-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            color: #856404;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .expense-form {
                grid-template-columns: 1fr;
            }

            .buckets-grid {
                grid-template-columns: 1fr;
            }

            .expense-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .expense-amount {
                margin-right: 0;
            }
        }

        .reset-btn {
            background: #ff6b6b;
            color: white;
            margin-top: 10px;
        }

        .reset-btn:hover {
            background: #ee5a5a;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Barefoot Budget Tracker</h1>
            <p>Modified Barefoot Investor System - Your Money, Your Way</p>
            <div class="sync-status" id="sync-status">
                <span id="sync-text">Not connected to Google Drive</span>
                <button class="sync-btn" id="sync-btn" onclick="handleGoogleDriveAuth()">Connect</button>
            </div>
        </div>

        <div class="card income-section">
            <h2>üìä Net Income</h2>
            <div class="income-input">
                <input type="number" id="income" placeholder="Enter your fortnightly net pay" value="2489.45" step="0.01">
            </div>
            <div class="income-amount">$<span id="income-display">2489.45</span></div>
        </div>

        <div class="card">
            <h2>ü™£ Your Money Buckets</h2>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: #333; margin-bottom: 10px; font-size: 1.1rem;">Quick Presets:</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 8px 16px; font-size: 0.9rem;" onclick="applyPreset('standard')">
                        üìò Standard Barefoot<br><small style="opacity: 0.9;">60/10/10/20</small>
                    </button>
                    <button class="btn btn-primary" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 8px 16px; font-size: 0.9rem;" onclick="applyPreset('aggressive')">
                        üí™ Aggressive Saving<br><small style="opacity: 0.9;">50/5/10/35</small>
                    </button>
                    <button class="btn btn-primary" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 8px 16px; font-size: 0.9rem;" onclick="applyPreset('balanced')">
                        ‚öñÔ∏è Balanced<br><small style="opacity: 0.9;">55/15/10/20</small>
                    </button>
                    <button class="btn btn-primary" style="background: linear-gradient(135deg, #ff9a56 0%, #ff6a00 100%); padding: 8px 16px; font-size: 0.9rem;" onclick="applyPreset('recovery')">
                        üö® Recovery Mode<br><small style="opacity: 0.9;">55/5/20/20</small>
                    </button>
                    <button class="btn btn-primary" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 8px 16px; font-size: 0.9rem;" onclick="applyPreset('custom')">
                        üéØ Your Custom<br><small style="opacity: 0.9;">Save current</small>
                    </button>
                </div>
            </div>

            <div class="buckets-grid">
                <div class="bucket bucket-bills">
                    <h3>üìã Bills (Fixed)</h3>
                    <div class="bucket-amount">$<span id="bills-amount">0.00</span></div>
                    <div class="bucket-percentage">Part of Daily Expenses</div>
                </div>

                <div class="bucket bucket-spending">
                    <h3>üõí Daily Spending</h3>
                    <div class="bucket-amount">$<span id="spending-amount">0.00</span></div>
                    <div class="bucket-percentage">Remainder of Daily Expenses</div>
                </div>

                <div class="bucket bucket-spending" style="grid-column: 1 / -1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h3>üìä Daily Expenses Total (Bills + Spending)</h3>
                    <div class="bucket-amount">$<span id="daily-total-amount">0.00</span></div>
                    <div class="bucket-percentage"><span id="daily-percent">60</span>%</div>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="60" class="slider" id="daily-slider">
                    </div>
                </div>

                <div class="bucket bucket-splurge">
                    <h3>üéâ Splurge</h3>
                    <div class="bucket-amount">$<span id="splurge-amount">0.00</span></div>
                    <div class="bucket-percentage"><span id="splurge-percent">10</span>%</div>
                    <div class="slider-container">
                        <input type="range" min="0" max="50" value="10" class="slider" id="splurge-slider">
                    </div>
                </div>

                <div class="bucket bucket-smile">
                    <h3>üòä Smile</h3>
                    <div class="bucket-amount">$<span id="smile-amount">0.00</span></div>
                    <div class="bucket-percentage"><span id="smile-percent">10</span>%</div>
                    <div class="slider-container">
                        <input type="range" min="0" max="50" value="10" class="slider" id="smile-slider">
                    </div>
                </div>

                <div class="bucket bucket-fire">
                    <h3>üî• Fire Extinguisher</h3>
                    <div class="bucket-amount">$<span id="fire-amount">0.00</span></div>
                    <div class="bucket-percentage"><span id="fire-percent">20</span>%</div>
                    <div class="slider-container">
                        <input type="range" min="0" max="50" value="20" class="slider" id="fire-slider">
                    </div>
                </div>
            </div>

            <div id="percentage-warning" style="display: none; background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin-top: 20px; color: #856404;"></div>

            <div class="note">
                üí° <strong>Tip:</strong> Adjust the sliders to customize your bucket percentages. For best results, make sure they add up to 100%. Daily Expenses is the total %, Bills stays fixed, and Daily Spending is the remainder.
            </div>
        </div>

        <div class="card expenses-section">
            <h2>üí≥ Bills & Expenses</h2>
            <div class="expense-form">
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="expense-name" placeholder="e.g., Rent">
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" id="expense-amount" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label>Frequency</label>
                    <select id="expense-frequency">
                        <option value="fortnightly">Fortnightly</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="oneoff">One-off</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="add-update-btn" onclick="addOrUpdateExpense()">Add</button>
            </div>

            <div class="expenses-list" id="expenses-list"></div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                <button class="btn reset-btn" onclick="resetExpenses()">Reset All Expenses</button>
                <button class="btn btn-primary" style="background: #2196F3;" onclick="exportData()">üì• Export Data</button>
                <button class="btn btn-primary" style="background: #FF9800;" onclick="document.getElementById('import-file').click()">üì§ Import Data</button>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script>
        // Google Drive Configuration
        // IMPORTANT: You need to replace these with your own credentials from Google Cloud Console
        const GOOGLE_CONFIG = {
            clientId: 'YOUR_CLIENT_ID.apps.googleusercontent.com', // Replace this!
            apiKey: 'YOUR_API_KEY', // Replace this!
            scope: 'https://www.googleapis.com/auth/drive.file',
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
        };

        let googleAuth = null;
        let driveFileId = null;
        const DRIVE_FILENAME = 'barefoot-budget-data.json';

        // Initial data from spreadsheet
        const initialExpenses = [
            { name: 'Car Loan', amount: 249.39, frequency: 'fortnightly' },
            { name: 'HCF Health Insurance', amount: 64, frequency: 'fortnightly' },
            { name: 'Optus (set aside)', amount: 40.81, frequency: 'monthly' },
            { name: 'Car Registration (set aside)', amount: 63.61, frequency: 'monthly' },
            { name: 'Toll Top-Up', amount: 116, frequency: 'fortnightly' },
            { name: 'RACQ Car Insurance', amount: 64, frequency: 'monthly' },
            { name: 'Amazon Prime', amount: 5, frequency: 'monthly' },
            { name: 'Apple Music', amount: 6.5, frequency: 'monthly' },
            { name: 'Google One', amount: 1.5, frequency: 'monthly' },
            { name: 'Psychologist Allocation', amount: 62, frequency: 'fortnightly' }
        ];

        let expenses = [];
        let netIncome = 2489.45;
        let percentages = {
            daily: 60,
            splurge: 10,
            smile: 10,
            fire: 20
        };
        let editingIndex = -1;
        
        // Preset configurations
        const presets = {
            standard: { daily: 60, splurge: 10, smile: 10, fire: 20, name: 'Standard Barefoot' },
            aggressive: { daily: 50, splurge: 5, smile: 10, fire: 35, name: 'Aggressive Saving' },
            balanced: { daily: 55, splurge: 15, smile: 10, fire: 20, name: 'Balanced' },
            recovery: { daily: 55, splurge: 5, smile: 20, fire: 20, name: 'Recovery Mode' }
        };
        
        let customPreset = null;

        // Google Drive Functions
        function initGoogleAPI() {
            gapi.load('client:auth2', () => {
                gapi.client.init({
                    apiKey: GOOGLE_CONFIG.apiKey,
                    clientId: GOOGLE_CONFIG.clientId,
                    discoveryDocs: GOOGLE_CONFIG.discoveryDocs,
                    scope: GOOGLE_CONFIG.scope
                }).then(() => {
                    googleAuth = gapi.auth2.getAuthInstance();
                    
                    // Check if already signed in
                    if (googleAuth.isSignedIn.get()) {
                        updateSyncStatus('connected');
                        loadFromGoogleDrive();
                    }
                    
                    // Listen for sign-in state changes
                    googleAuth.isSignedIn.listen(updateSigninStatus);
                }).catch(error => {
                    console.error('Error initializing Google API:', error);
                    updateSyncStatus('error', 'Failed to initialize');
                });
            });
        }

        function handleGoogleDriveAuth() {
            if (!googleAuth) {
                alert('Google Drive is still loading. Please wait a moment and try again.');
                return;
            }

            if (googleAuth.isSignedIn.get()) {
                // Sign out
                googleAuth.signOut().then(() => {
                    updateSyncStatus('disconnected');
                    driveFileId = null;
                    localStorage.removeItem('driveFileId');
                });
            } else {
                // Sign in
                googleAuth.signIn().then(() => {
                    updateSyncStatus('connected');
                    loadFromGoogleDrive();
                }).catch(error => {
                    console.error('Error signing in:', error);
                    alert('Failed to connect to Google Drive. Please try again.');
                });
            }
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                updateSyncStatus('connected');
                loadFromGoogleDrive();
            } else {
                updateSyncStatus('disconnected');
            }
        }

        function updateSyncStatus(status, message) {
            const statusEl = document.getElementById('sync-status');
            const textEl = document.getElementById('sync-text');
            const btnEl = document.getElementById('sync-btn');

            statusEl.className = 'sync-status';
            
            switch(status) {
                case 'connected':
                    statusEl.classList.add('connected');
                    textEl.textContent = '‚úì Synced with Google Drive';
                    btnEl.textContent = 'Disconnect';
                    break;
                case 'syncing':
                    statusEl.classList.add('syncing');
                    textEl.textContent = '‚ü≥ Syncing...';
                    btnEl.textContent = 'Disconnect';
                    break;
                case 'disconnected':
                    textEl.textContent = 'Not connected to Google Drive';
                    btnEl.textContent = 'Connect';
                    break;
                case 'error':
                    textEl.textContent = `‚ö†Ô∏è ${message || 'Sync error'}`;
                    btnEl.textContent = 'Retry';
                    break;
            }
        }

        async function loadFromGoogleDrive() {
            try {
                updateSyncStatus('syncing');
                
                // Get stored file ID or search for file
                driveFileId = localStorage.getItem('driveFileId');
                
                if (!driveFileId) {
                    // Search for existing file
                    const response = await gapi.client.drive.files.list({
                        q: `name='${DRIVE_FILENAME}' and trashed=false`,
                        spaces: 'drive',
                        fields: 'files(id, name)'
                    });
                    
                    if (response.result.files.length > 0) {
                        driveFileId = response.result.files[0].id;
                        localStorage.setItem('driveFileId', driveFileId);
                    }
                }
                
                if (driveFileId) {
                    // Load existing file
                    const response = await gapi.client.drive.files.get({
                        fileId: driveFileId,
                        alt: 'media'
                    });
                    
                    const data = response.result;
                    if (data.expenses) expenses = data.expenses;
                    if (data.netIncome) netIncome = data.netIncome;
                    if (data.percentages) percentages = data.percentages;
                    if (data.customPreset) customPreset = data.customPreset;
                    
                    // Update UI
                    document.getElementById('income').value = netIncome;
                    updateAllSliders();
                    renderExpenses();
                    updatePresetButtonLabel();
                }
                
                updateSyncStatus('connected');
            } catch (error) {
                console.error('Error loading from Google Drive:', error);
                updateSyncStatus('error', 'Failed to load data');
            }
        }

        async function saveToGoogleDrive() {
            if (!googleAuth || !googleAuth.isSignedIn.get()) {
                // Not connected, fall back to localStorage
                saveToLocalStorage();
                return;
            }

            try {
                updateSyncStatus('syncing');
                
                const data = {
                    expenses,
                    netIncome,
                    percentages,
                    customPreset,
                    lastModified: new Date().toISOString()
                };
                
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const closeDelim = "\r\n--" + boundary + "--";
                
                const contentType = 'application/json';
                const metadata = {
                    name: DRIVE_FILENAME,
                    mimeType: contentType
                };
                
                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(metadata) +
                    delimiter +
                    'Content-Type: ' + contentType + '\r\n\r\n' +
                    JSON.stringify(data) +
                    closeDelim;
                
                let request;
                if (driveFileId) {
                    // Update existing file
                    request = gapi.client.request({
                        path: '/upload/drive/v3/files/' + driveFileId,
                        method: 'PATCH',
                        params: { uploadType: 'multipart' },
                        headers: {
                            'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                        },
                        body: multipartRequestBody
                    });
                } else {
                    // Create new file
                    request = gapi.client.request({
                        path: '/upload/drive/v3/files',
                        method: 'POST',
                        params: { uploadType: 'multipart' },
                        headers: {
                            'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                        },
                        body: multipartRequestBody
                    });
                }
                
                const response = await request;
                if (!driveFileId) {
                    driveFileId = response.result.id;
                    localStorage.setItem('driveFileId', driveFileId);
                }
                
                updateSyncStatus('connected');
                
                // Also save to localStorage as backup
                saveToLocalStorage();
            } catch (error) {
                console.error('Error saving to Google Drive:', error);
                updateSyncStatus('error', 'Failed to save');
                
                // Fall back to localStorage
                saveToLocalStorage();
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('budgetData', JSON.stringify({
                expenses,
                netIncome,
                percentages,
                customPreset
            }));
        }

        // Load from localStorage or use initial data
        function loadData() {
            const saved = localStorage.getItem('budgetData');
            if (saved) {
                const data = JSON.parse(saved);
                expenses = data.expenses || initialExpenses;
                netIncome = data.netIncome || 2489.45;
                percentages = data.percentages || percentages;
                customPreset = data.customPreset || null;
            } else {
                expenses = [...initialExpenses];
            }

            document.getElementById('income').value = netIncome;
            updateAllSliders();
            updatePresetButtonLabel();
        }

        function saveData() {
            saveToGoogleDrive();
        }

        function calculateBuckets() {
            // Calculate total bills (fortnightly equivalent)
            let totalBills = 0;
            expenses.forEach(exp => {
                let fortnightlyAmount = exp.amount;
                if (exp.frequency === 'weekly') {
                    fortnightlyAmount = exp.amount * 2;
                } else if (exp.frequency === 'monthly') {
                    fortnightlyAmount = exp.amount / 2;
                } else if (exp.frequency === 'oneoff') {
                    fortnightlyAmount = 0; // One-off expenses don't count towards regular bills
                }
                totalBills += fortnightlyAmount;
            });

            const dailyTotal = netIncome * (percentages.daily / 100);
            const spending = Math.max(0, dailyTotal - totalBills);
            const splurge = netIncome * (percentages.splurge / 100);
            const smile = netIncome * (percentages.smile / 100);
            const fire = netIncome * (percentages.fire / 100);

            document.getElementById('bills-amount').textContent = totalBills.toFixed(2);
            document.getElementById('spending-amount').textContent = spending.toFixed(2);
            document.getElementById('daily-total-amount').textContent = dailyTotal.toFixed(2);
            document.getElementById('splurge-amount').textContent = splurge.toFixed(2);
            document.getElementById('smile-amount').textContent = smile.toFixed(2);
            document.getElementById('fire-amount').textContent = fire.toFixed(2);
            document.getElementById('income-display').textContent = netIncome.toFixed(2);
        }

        function renderExpenses() {
            const list = document.getElementById('expenses-list');
            list.innerHTML = expenses.map((exp, index) => {
                let fortnightlyAmount = exp.amount;
                let displayFreq = exp.frequency;
                
                if (exp.frequency === 'weekly') {
                    fortnightlyAmount = exp.amount * 2;
                } else if (exp.frequency === 'monthly') {
                    fortnightlyAmount = exp.amount / 2;
                }

                return `
                    <div class="expense-item">
                        <div class="expense-info">
                            <div class="expense-name">${exp.name}</div>
                            <div class="expense-meta">
                                <span class="frequency-badge badge-${exp.frequency}">${exp.frequency}</span>
                                ${exp.frequency !== 'fortnightly' && exp.frequency !== 'oneoff' ? 
                                    `<span style="color: #999; margin-left: 10px;">‚âà $${fortnightlyAmount.toFixed(2)}/fortnight</span>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="expense-amount">$${exp.amount.toFixed(2)}</div>
                            <button class="btn btn-primary" style="background: #4CAF50; padding: 5px 10px; font-size: 0.9rem;" onclick="editExpense(${index})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteExpense(${index})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');

            calculateBuckets();
        }

        function addOrUpdateExpense() {
            const name = document.getElementById('expense-name').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const frequency = document.getElementById('expense-frequency').value;

            if (!name || isNaN(amount) || amount <= 0) {
                alert('Please enter a valid expense name and amount');
                return;
            }

            if (editingIndex >= 0) {
                // Update existing expense
                expenses[editingIndex] = { name, amount, frequency };
                editingIndex = -1;
                document.getElementById('add-update-btn').textContent = 'Add';
                document.getElementById('add-update-btn').style.background = '';
            } else {
                // Add new expense
                expenses.push({ name, amount, frequency });
            }
            
            document.getElementById('expense-name').value = '';
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-frequency').value = 'fortnightly';
            
            saveData();
            renderExpenses();
        }

        function editExpense(index) {
            const expense = expenses[index];
            document.getElementById('expense-name').value = expense.name;
            document.getElementById('expense-amount').value = expense.amount;
            document.getElementById('expense-frequency').value = expense.frequency;
            
            editingIndex = index;
            document.getElementById('add-update-btn').textContent = 'Update';
            document.getElementById('add-update-btn').style.background = '#FF9800';
            
            // Scroll to form
            document.querySelector('.expenses-section').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteExpense(index) {
            if (confirm('Are you sure you want to delete this expense?')) {
                expenses.splice(index, 1);
                if (editingIndex === index) {
                    editingIndex = -1;
                    document.getElementById('add-update-btn').textContent = 'Add';
                    document.getElementById('add-update-btn').style.background = '';
                    document.getElementById('expense-name').value = '';
                    document.getElementById('expense-amount').value = '';
                    document.getElementById('expense-frequency').value = 'fortnightly';
                }
                saveData();
                renderExpenses();
            }
        }

        function resetExpenses() {
            if (confirm('Are you sure you want to reset all expenses to the initial data?')) {
                expenses = [...initialExpenses];
                editingIndex = -1;
                document.getElementById('add-update-btn').textContent = 'Add';
                document.getElementById('add-update-btn').style.background = '';
                saveData();
                renderExpenses();
            }
        }

        function exportData() {
            const data = {
                expenses,
                netIncome,
                percentages,
                customPreset,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `budget-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.expenses) expenses = data.expenses;
                    if (data.netIncome) netIncome = data.netIncome;
                    if (data.percentages) percentages = data.percentages;
                    if (data.customPreset) customPreset = data.customPreset;
                    
                    // Update UI
                    document.getElementById('income').value = netIncome;
                    
                    updateAllSliders();
                    
                    saveData();
                    renderExpenses();
                    updatePresetButtonLabel();
                    
                    alert('Data imported successfully!');
                } catch (error) {
                    alert('Error importing data. Please make sure the file is valid.');
                    console.error(error);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        function applyPreset(presetName) {
            if (presetName === 'custom') {
                // Save current percentages as custom preset
                customPreset = { ...percentages };
                saveData();
                updatePresetButtonLabel();
                alert('Current percentages saved as your custom preset!');
                return;
            }
            
            const preset = presets[presetName];
            if (!preset) return;
            
            percentages.daily = preset.daily;
            percentages.splurge = preset.splurge;
            percentages.smile = preset.smile;
            percentages.fire = preset.fire;
            
            updateAllSliders();
            
            saveData();
            calculateBuckets();
        }

        function updatePresetButtonLabel() {
            const customBtn = document.querySelector('button[onclick="applyPreset(\'custom\')"]');
            if (!customBtn) return;
            
            if (customPreset) {
                const percentText = `${customPreset.daily}/${customPreset.splurge}/${customPreset.smile}/${customPreset.fire}`;
                customBtn.innerHTML = `üéØ Your Custom<br><small style="opacity: 0.9;">${percentText}</small>`;
                customBtn.onclick = function() {
                    if (confirm('Load your saved custom preset?')) {
                        applyPreset('custom-load');
                    }
                };
            } else {
                customBtn.innerHTML = `üéØ Save Custom<br><small style="opacity: 0.9;">Save current %</small>`;
                customBtn.onclick = function() { applyPreset('custom'); };
            }
        }

        // Modified applyPreset to handle custom-load
        const originalApplyPreset = applyPreset;
        applyPreset = function(presetName) {
            if (presetName === 'custom-load' && customPreset) {
                percentages.daily = customPreset.daily;
                percentages.splurge = customPreset.splurge;
                percentages.smile = customPreset.smile;
                percentages.fire = customPreset.fire;
                
                updateAllSliders();
                
                saveData();
                calculateBuckets();
                return;
            }
            originalApplyPreset(presetName);
        };

        // Event listeners
        document.getElementById('income').addEventListener('input', (e) => {
            netIncome = parseFloat(e.target.value) || 0;
            saveData();
            calculateBuckets();
        });

        document.getElementById('daily-slider').addEventListener('input', (e) => {
            percentages.daily = parseInt(e.target.value);
            document.getElementById('daily-percent').textContent = percentages.daily;
            checkPercentageTotal();
            saveData();
            calculateBuckets();
        });

        document.getElementById('splurge-slider').addEventListener('input', (e) => {
            percentages.splurge = parseInt(e.target.value);
            document.getElementById('splurge-percent').textContent = percentages.splurge;
            checkPercentageTotal();
            saveData();
            calculateBuckets();
        });

        document.getElementById('smile-slider').addEventListener('input', (e) => {
            percentages.smile = parseInt(e.target.value);
            document.getElementById('smile-percent').textContent = percentages.smile;
            checkPercentageTotal();
            saveData();
            calculateBuckets();
        });

        document.getElementById('fire-slider').addEventListener('input', (e) => {
            percentages.fire = parseInt(e.target.value);
            document.getElementById('fire-percent').textContent = percentages.fire;
            checkPercentageTotal();
            saveData();
            calculateBuckets();
        });

        function checkPercentageTotal() {
            const total = percentages.daily + percentages.splurge + percentages.smile + percentages.fire;
            const warning = document.getElementById('percentage-warning');
            
            if (total !== 100) {
                warning.style.display = 'block';
                warning.innerHTML = `‚ö†Ô∏è <strong>Warning:</strong> Your percentages add up to ${total}% (should be 100%)`;
                warning.style.background = total > 100 ? '#ffe5e5' : '#fff3cd';
                warning.style.borderColor = total > 100 ? '#ff4444' : '#ffc107';
                warning.style.color = total > 100 ? '#cc0000' : '#856404';
            } else {
                warning.style.display = 'none';
            }
        }

        function updateAllSliders() {
            document.getElementById('daily-slider').value = percentages.daily;
            document.getElementById('splurge-slider').value = percentages.splurge;
            document.getElementById('smile-slider').value = percentages.smile;
            document.getElementById('fire-slider').value = percentages.fire;
            
            document.getElementById('daily-percent').textContent = percentages.daily;
            document.getElementById('splurge-percent').textContent = percentages.splurge;
            document.getElementById('smile-percent').textContent = percentages.smile;
            document.getElementById('fire-percent').textContent = percentages.fire;
            
            checkPercentageTotal();
        }

        // Initialize
        loadData();
        renderExpenses();
        
        // Initialize Google Drive API when page loads
        window.onload = function() {
            if (typeof gapi !== 'undefined') {
                initGoogleAPI();
            } else {
                // Wait for gapi to load
                setTimeout(() => {
                    if (typeof gapi !== 'undefined') {
                        initGoogleAPI();
                    }
                }, 1000);
            }
        };
    </script>
</body>
</html>
